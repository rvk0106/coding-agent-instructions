# Ticketing Systems (when MCP is not configured)

> **This file vs `agent/fetch-ticket.sh`**: `fetch-ticket.sh` (generated by install.sh) is the quick wrapper -- it reads config from `agent-config.md` and auto-detects the ticketing system. Use it first. This file is the **detailed reference** -- use it when `fetch-ticket.sh` is not available, when you need markdown-friendly output, or when you need to customize the fetching logic.

## Token sources

- **Environment:** `LINEAR_API_TOKEN`, `JIRA_API_TOKEN` + `JIRA_URL`, `GITHUB_TOKEN` + `GITHUB_REPO`
- **Node.js:** If not in env, you can use `node -e "console.log(process.env.LINEAR_API_TOKEN)"` for token lookup.
- **agent-config.md:** If using `agent/fetch-ticket.sh`, it reads uncommented `VAR=value` lines from `agent-config.md`.

---

## Linear

Fetch a single issue by **id** (UUID from Linear URL or API). For identifier like `PROJ-123`, resolve id first or use the GraphQL query that accepts identifier.

```bash
linear_issue() {
  local ISSUE_ID="$1"
  local TOKEN="${LINEAR_API_TOKEN:-}"

  if [ -z "$TOKEN" ]; then
    echo "Error: LINEAR_API_TOKEN not found in environment variables"
    return 1
  fi

  curl -s https://api.linear.app/graphql \
    -H "Content-Type: application/json" \
    -H "Authorization: $TOKEN" \
    -d @- <<EOF | jq
{
  "query": "query { issue(id: \"$ISSUE_ID\") { id identifier title description state { name } assignee { name } createdAt updatedAt } }"
}
EOF
}
```

**Markdown-friendly output:**

```bash
linear_issue_md() {
  local ISSUE_ID="$1"
  local TOKEN="${LINEAR_API_TOKEN:-}"
  if [ -z "$TOKEN" ]; then
    echo "Error: LINEAR_API_TOKEN not set"; return 1
  fi
  curl -s https://api.linear.app/graphql \
    -H "Content-Type: application/json" \
    -H "Authorization: $TOKEN" \
    -d "{\"query\": \"query { issue(id: \\\"$ISSUE_ID\\\") { id identifier title description state { name } assignee { name } } }\"}" | \
  jq -r '.data.issue | "# [\(.identifier)] \(.title)\n\n## Description\n\(.description // "")\n\n## State\n\(.state.name)\n\n## Assignee\n\(.assignee.name // "Unassigned")"'
}
```

---

## Jira

Fetch an issue by **issue key** (e.g. `PROJ-123`). Requires `JIRA_URL` (e.g. `https://your-domain.atlassian.net`) and `JIRA_API_TOKEN`.

```bash
jira_issue() {
  local ISSUE_KEY="$1"
  local TOKEN="${JIRA_API_TOKEN:-}"
  local URL="${JIRA_URL:-}"

  if [ -z "$TOKEN" ] || [ -z "$URL" ]; then
    echo "Error: JIRA_API_TOKEN and JIRA_URL must be set"
    return 1
  fi

  curl -s "$URL/rest/api/3/issue/$ISSUE_KEY" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" | jq
}
```

**Markdown-friendly:**

```bash
jira_issue_md() {
  local ISSUE_KEY="$1"
  local TOKEN="${JIRA_API_TOKEN:-}"
  local URL="${JIRA_URL:-}"
  if [ -z "$TOKEN" ] || [ -z "$URL" ]; then
    echo "Error: JIRA_API_TOKEN and JIRA_URL must be set"; return 1
  fi
  curl -s "$URL/rest/api/3/issue/$ISSUE_KEY" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" | \
  jq -r '"# [\(.key)] \(.fields.summary)\n\n## Description\n\(.fields.description.content[0].content[0].text // "No description")\n\n## Status\n\(.fields.status.name)\n\n## Assignee\n\(.fields.assignee.displayName // "Unassigned")"'
}
```

---

## GitHub Issues

Fetch an issue by **repo** and **issue number**. Requires `GITHUB_TOKEN` and `GITHUB_REPO` (e.g. `owner/repo`).

```bash
github_issue() {
  local REPO="${GITHUB_REPO:-}"
  local NUM="$1"
  local TOKEN="${GITHUB_TOKEN:-}"

  if [ -z "$TOKEN" ] || [ -z "$REPO" ]; then
    echo "Error: GITHUB_TOKEN and GITHUB_REPO must be set"
    return 1
  fi

  curl -s "https://api.github.com/repos/$REPO/issues/$NUM" \
    -H "Authorization: token $TOKEN" \
    -H "Accept: application/vnd.github.v3+json" | jq
}
```

**Markdown-friendly:**

```bash
github_issue_md() {
  local REPO="${GITHUB_REPO:-}"
  local NUM="$1"
  local TOKEN="${GITHUB_TOKEN:-}"
  if [ -z "$TOKEN" ] || [ -z "$REPO" ]; then
    echo "Error: GITHUB_TOKEN and GITHUB_REPO must be set"; return 1
  fi
  curl -s "https://api.github.com/repos/$REPO/issues/$NUM" \
    -H "Authorization: token $TOKEN" \
    -H "Accept: application/vnd.github.v3+json" | \
  jq -r '"# [#\(.number)] \(.title)\n\n## Description\n\(.body // "No description")\n\n## State\n\(.state)\n\n## Assignee\n\(.assignee.login // "Unassigned")"'
}
```

**Usage:** `export GITHUB_REPO=owner/repo` then `github_issue_md 42`.

---

## Using in the project

1. **Prefer `agent/fetch-ticket.sh`**
   If present (created by install), run:
   ```bash
   source agent/fetch-ticket.sh
   fetch_ticket TICKET-ID
   ```
   It reads tokens from `agent-config.md` and picks Linear/Jira/GitHub from configured vars.

2. **Otherwise**
   Copy the functions above into a script or source a file that defines them, set the required env vars, then run e.g.:
   - `linear_issue "<uuid>"` or `linear_issue_md "<uuid>"`
   - `jira_issue PROJ-123` or `jira_issue_md PROJ-123`
   - `github_issue_md 42` (with `GITHUB_REPO` set)

3. **Save to `tickets/`**
   To create a local ticket file for the agent:
   ```bash
   linear_issue_md "<uuid>" > tickets/PROJ-123.md
   ```

**Dependencies:** `curl` and `jq` must be available.
